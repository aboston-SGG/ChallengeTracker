<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <meta charset="UTF-8" />
  <title>Create Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 700px;
      margin: 3rem auto;
      padding: 1rem;
    }
    label {
      display: block;
      margin-top: 1.25rem;
      font-weight: 600;
    }
    input, textarea, button {
      width: 100%;
      margin-top: 0.5rem;
      padding: 0.6rem;
      font-size: 1rem;
    }
    textarea {
      min-height: 80px;
    }
    button {
      margin-top: 2rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Create a Challenge</h1>

  <form id="challengeForm">
    <label>
      Challenge Title
      <input type="text" placeholder="Nuzlocke Run" required />
    </label>

    <label>
      Game
      <input type="text" placeholder="Pokémon Emerald" required />
    </label>

    <label>
      Description
      <textarea placeholder="Rules and overview of the challenge"></textarea>
    </label>

    <label>
      Objectives (one per line)
      <textarea placeholder="Catch first Pokémon in each area&#10;No items in battle&#10;Permadeath"></textarea>
    </label>

    <button type="submit">Create Challenge</button>
  </form>

<script>
const SUPABASE_URL = "https://ffbqgczghzervntyhfvd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmYnFnY3pnaHplcnZudHloZnZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNzU1MTAsImV4cCI6MjA4Mzk1MTUxMH0.N8eowQR-yhK9Hd6PrvxdHR30GYWc7U2xGdzJNw4u5U4";

const supabaseClient = supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);
  const form = document.getElementById("challengeForm");

  function generateKey() {
    return Math.random().toString(36).substring(2, 10);
  }

  form.addEventListener("submit", async function (e) {
  e.preventDefault();

  const title = form.querySelector('input[placeholder="Nuzlocke Run"]').value;
  const game = form.querySelector('input[placeholder="Pokémon Emerald"]').value;
  const description = form.querySelector('textarea').value;
  const objectivesText = form.querySelectorAll('textarea')[1].value;

  const objectives = objectivesText
    .split("\n")
    .map(o => o.trim())
    .filter(o => o.length > 0)
    .map(o => ({ text: o, done: false }));

  const editKey = Math.random().toString(36).substring(2, 10);

  // Insert into Supabase
  const { data, error } = await supabaseClient
    .from("challenges")
    .insert([
      { title, game, description, objectives, edit_key: editKey }
    ])
    .select()
    .single();

  if (error) {
    alert("Error saving challenge: " + error.message);
    return;
  }

  // Redirect to permanent URL
  window.location.href = `view.html?id=${data.id}&edit=${editKey}`;
});
</script>

</body>
</html>
