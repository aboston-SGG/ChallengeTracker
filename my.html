<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Challenges</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="main.js"></script>
<style>
.challenge-card { background:#fff; padding:1rem; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:2rem; }
.challenge-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.15); }
.objective { margin-bottom:1rem; padding:0.75rem; border:1px solid #ddd; border-radius:6px; }
.subobjective { margin-left:1.5rem; border-left:2px solid #eee; padding-left:0.5rem; display:flex; align-items:center; }
.objective-title { font-weight:bold; margin-left:0.5rem; }
.progress-container { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; }
.progress-bar { flex:1; height:1rem; border-radius:0.25rem; background:#eee; overflow:hidden; }
.progress-fill { height:100%; background:#facc15; width:0%; transition:width 0.3s ease; }
.toggle-sub { font-size:0.8rem; margin-left:0.5rem; cursor:pointer; background:#f3f4f6; padding:0.2rem 0.5rem; border-radius:4px; }
</style>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="create.html">Create</a>
  <a href="browse.html">Browse</a>
  <a href="my.html">My Challenges</a>
  <a href="feed.html">Feed</a>
  <a href="#" id="auth-link">Login</a>
</nav>

<div id="my-challenges"></div>

<script>
updateAuthLink();

async function loadMyChallenges() {
  const user = await getCurrentUser();
  if(!user){ document.getElementById("my-challenges").innerHTML="<p>Please log in to view your challenges.</p>"; return; }

  const { data: userChallenges, error } = await supabaseClient
    .from("user_challenges")
    .select(`*, challenges(*)`)
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if(error){ console.error(error); return; }

  const container = document.getElementById("my-challenges");
  container.innerHTML = "";

  userChallenges.forEach(uc=>{
    const ch = uc.challenges;
    const div = document.createElement("div");
    div.className = "challenge-card";

    div.innerHTML = `
      <h2>${ch.title}</h2>
      <p class="meta">Game: ${ch.game}</p>
      <p>${ch.description}</p>
      <div class="progress-container">
        <div class="progress-bar"><div class="progress-fill"></div></div>
        <span class="progress-text">0%</span>
      </div>
      <div class="objectives-container"></div>
    `;

    container.appendChild(div);

    const objectivesContainer = div.querySelector(".objectives-container");
    const objectives = ch.objectives || [];

    objectives.forEach((obj, idx)=>{
      const objDiv = document.createElement("div");
      objDiv.className="objective";

      const objCheckbox = document.createElement("input");
      objCheckbox.type="checkbox";
      objCheckbox.checked = obj.done || false;

      objCheckbox.addEventListener("change", async ()=>{
        obj.done = objCheckbox.checked;
        updateProgressBar(div, objectives);
        await supabaseClient.from("user_challenges").update({objectives}).eq("id",uc.id);
      });

      const objTitle = document.createElement("span");
      objTitle.className="objective-title";
      objTitle.textContent = obj.title + ": " + obj.description;

      objDiv.appendChild(objCheckbox);
      objDiv.appendChild(objTitle);

      // Sub-objectives
      if(obj.subObjectives && obj.subObjectives.length){
        const toggle = document.createElement("button");
        toggle.className="toggle-sub";
        toggle.textContent="Toggle Sub-Objectives";
        let subVisible = true;
        toggle.addEventListener("click", ()=>{ 
          subVisible = !subVisible; 
          subContainer.style.display = subVisible?"block":"none"; 
        });
        objDiv.appendChild(toggle);

        const subContainer = document.createElement("div");
        obj.subObjectives.forEach((sub,sidx)=>{
          const subDiv = document.createElement("div");
          subDiv.className="subobjective";

          const subCheckbox = document.createElement("input");
          subCheckbox.type="checkbox";
          subCheckbox.checked = sub.done || false;

          subCheckbox.addEventListener("change", async ()=>{
            sub.done = subCheckbox.checked;
            updateProgressBar(div, objectives);
            await supabaseClient.from("user_challenges").update({objectives}).eq("id",uc.id);
          });

          const subTitle = document.createElement("span");
          subTitle.textContent = sub.title + ": " + sub.description;

          subDiv.appendChild(subCheckbox);
          subDiv.appendChild(subTitle);
          subContainer.appendChild(subDiv);
        });
        objDiv.appendChild(subContainer);
      }

      objectivesContainer.appendChild(objDiv);
    });

    updateProgressBar(div, objectives);
  });
}

function updateProgressBar(div, objectives){
  let total=0, done=0;
  objectives.forEach(obj=>{
    total++; if(obj.done) done++;
    (obj.subObjectives||[]).forEach(sub=>{total++; if(sub.done) done++;});
  });
  const percent = total?Math.round(done/total*100):0;
  div.querySelector(".progress-fill").style.width = percent+"%";
  div.querySelector(".progress-text").textContent = percent+"%";
}

loadMyChallenges();
</script>

</body>
</html>
