<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Browse Challenges</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="main.js"></script>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="create.html">Create</a>
  <a href="browse.html">Browse</a>
  <a href="my.html">My Challenges</a>
  <a href="feed.html">Feed</a>
  <a href="auth.html" id="auth-link">Login</a>
</nav>

<div class="page-container">
  <h1 style="text-align:center; margin-top:1rem;">Browse Challenges</h1>
  <div id="challenge-list" class="challenge-list"></div>
</div>

<script>
updateAuthLink();

// Load all challenges
async function loadChallenges() {
  const { data, error } = await supabaseClient
    .from("challenges")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  const container = document.getElementById("challenge-list");
  container.innerHTML = "";

  data.forEach(ch => {
    const div = document.createElement("div");
    div.className = "challenge-card";

    div.innerHTML = `
      <h2>${ch.title}</h2>
      <p class="meta">Game: ${ch.game}</p>
      <p>${ch.description}</p>
      <div style="display:flex; justify-content:space-between; margin-top:1rem;">
        <a href="view.html?id=${ch.id}">
          <button>View Challenge</button>
        </a>
        <button class="like-btn" data-id="${ch.id}">❤️ Like</button>
      </div>
    `;

    // Like button functionality
    const likeBtn = div.querySelector(".like-btn");
    likeBtn.addEventListener("click", async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return alert("Please log in to like a challenge.");

      // Toggle like
      const { data: existing } = await supabaseClient
        .from("challenge_likes")
        .select("id")
        .eq("challenge_id", ch.id)
        .eq("user_id", user.id)
        .single();

      if (existing) {
        await supabaseClient.from("challenge_likes").delete().eq("id", existing.id);
      } else {
        await supabaseClient.from("challenge_likes").insert({
          challenge_id: ch.id,
          user_id: user.id
        });
      }

      // Optionally reload challenges or update like count here
      loadChallenges();
    });

    container.appendChild(div);
  });
}

loadChallenges();
</script>

</body>
</html>
