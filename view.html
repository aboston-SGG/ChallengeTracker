<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>View Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="main.js"></script>
<style>
body { font-family: system-ui, sans-serif; max-width: 700px; margin: 3rem auto; padding: 1rem; }
ul { padding-left: 0; list-style: none; }
li { margin-bottom: 0.5rem; display: flex; align-items: center; }
li span { margin-left: 0.5rem; } /* text next to checkbox */
.meta { color: #555; margin-bottom: 1rem; }
.comment { padding: 8px; border-bottom: 1px solid #444; }
.objective { margin-left: 0; }
.subobjective { margin-left: 1.5rem; }
.progress-bar { width: 100%; background: #ddd; height: 12px; margin: 5px 0; border-radius: 6px; }
.progress-fill { background: #4caf50; height: 100%; width: 0%; border-radius: 6px; }
</style>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="create.html">Create</a>
  <a href="browse.html">Browse</a>
  <a href="my.html">My Challenges</a>
  <a href="feed.html">Feed</a>
  <a href="auth.html" id="auth-link">Login</a>
</nav>

<h1 id="title"></h1>
<div class="meta" id="game"></div>
<p id="description"></p>

<!-- Likes -->
<button id="like-btn">üëç Like</button> <span id="like-count">0</span> likes

<!-- Progress -->
<p id="progress"></p>
<div class="progress-bar"><div class="progress-fill"></div></div>

<h2>Objectives</h2>
<ul id="objectives"></ul>

<!-- Comments -->
<h2>Discussion</h2>
<div id="comments"></div>
<textarea id="comment-input" placeholder="Write a comment..."></textarea><br>
<button id="post-comment">Post Comment</button>

<script>
const SUPABASE_URL = "https://ffbqgczghzervntyhfvd.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY"; // replace with your anon key
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const params = new URLSearchParams(window.location.search);
const challengeId = params.get("id");
let challengeData = null;

updateAuthLink();

// Load Challenge
async function loadChallenge() {
  const { data, error } = await supabaseClient
    .from("challenges")
    .select("*")
    .eq("id", challengeId)
    .single();

  if (error || !data) return document.body.innerHTML = "<p>Challenge not found.</p>";

  challengeData = data;
  renderChallenge(data);
  loadLikes();
  loadComments();
}

function renderChallenge(data) {
  document.getElementById("title").textContent = data.title;
  document.getElementById("game").textContent = "Game: " + data.game;
  document.getElementById("description").textContent = data.description;

  const list = document.getElementById("objectives");
  list.innerHTML = "";

  (data.objectives || []).forEach((obj) => {
    const li = document.createElement("li");
    li.className = "objective";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = obj.done || false;

    cb.addEventListener("change", async () => {
      obj.done = cb.checked;
      updateProgress();
      await saveProgress();
    });

    li.appendChild(cb);
    const textSpan = document.createElement("span");
    textSpan.textContent = obj.title;
    li.appendChild(textSpan);
    list.appendChild(li);

    // Sub-objectives
    (obj.subObjectives || []).forEach(sub => {
      const subLi = document.createElement("li");
      subLi.className = "subobjective";

      const subCb = document.createElement("input");
      subCb.type = "checkbox";
      subCb.checked = sub.done || false;

      subCb.addEventListener("change", async () => {
        sub.done = subCb.checked;
        updateProgress();
        await saveProgress();
      });

      subLi.appendChild(subCb);
      const subText = document.createElement("span");
      subText.textContent = sub.title;
      subLi.appendChild(subText);
      list.appendChild(subLi);
    });
  });

  updateProgress();
}

function updateProgress() {
  const objectives = challengeData.objectives || [];
  let total = 0, done = 0;

  objectives.forEach(o => {
    total++; if (o.done) done++;
    (o.subObjectives || []).forEach(s => { total++; if (s.done) done++; });
  });

  const percent = total ? Math.round(done / total * 100) : 0;
  document.getElementById("progress").textContent = `Progress: ${done} / ${total} (${percent}%)`;
  document.querySelector(".progress-fill").style.width = percent + "%";
}

// Save progress
async function saveProgress() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return;

  const { error } = await supabaseClient
    .from("user_challenges")
    .update({ objectives: challengeData.objectives })
    .eq("challenge_id", challengeId)
    .eq("user_id", user.id);

  if (error) console.error("Error saving progress:", error.message);
  else await logActivity(user.id, challengeId);
}

// Likes
const likeBtn = document.getElementById("like-btn");
const likeCount = document.getElementById("like-count");
likeBtn.addEventListener("click", toggleLike);

async function loadLikes() {
  const { data, error } = await supabaseClient
    .from("challenge_likes")
    .select("user_id")
    .eq("challenge_id", challengeId);

  if (error) return console.error(error);

  likeCount.textContent = data.length;

  const { data: { user } } = await supabaseClient.auth.getUser();
  if (user && data.some(l => l.user_id === user.id)) likeBtn.textContent = "üíî Unlike";
  else likeBtn.textContent = "üëç Like";
}

async function toggleLike() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return alert("Login required.");

  const { data: existing } = await supabaseClient
    .from("challenge_likes")
    .select("id")
    .eq("challenge_id", challengeId)
    .eq("user_id", user.id)
    .single();

  if (existing) {
    await supabaseClient.from("challenge_likes").delete().eq("id", existing.id);
  } else {
    await supabaseClient.from("challenge_likes").insert({ challenge_id: challengeId, user_id: user.id });
  }

  loadLikes();
}

// Comments
document.getElementById("post-comment").addEventListener("click", postComment);

async function loadComments() {
  const { data, error } = await supabaseClient
    .from("comments")
    .select("content, created_at, user_id")
    .eq("challenge_id", challengeId)
    .order("created_at", { ascending: true });

  if (error) return console.error(error);

  const container = document.getElementById("comments");
  container.innerHTML = "";

  data.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `
      <p>${c.content}</p>
      <small>${new Date(c.created_at).toLocaleString()}</small>
    `;
    container.appendChild(div);
  });
}

async function postComment() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return alert("Login required.");

  const content = document.getElementById("comment-input").value.trim();
  if (!content) return;

  const { error } = await supabaseClient.from("comments").insert({
    user_id: user.id,
    challenge_id: challengeId,
    content
  });

  if (error) return console.error(error.message);

  document.getElementById("comment-input").value = "";
  loadComments();
}

// Activity log
async function logActivity(userId, challengeId) {
  await supabaseClient.from("activity").insert({
    user_id: userId,
    challenge_id: challengeId,
    action: "updated progress"
  });
}

// Initial load
loadChallenge();
</script>
</body>
</html>
