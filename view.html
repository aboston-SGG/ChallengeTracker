<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>View Challenge</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="main.js"></script>
<style>
.objective { margin-bottom:1rem; padding:0.75rem; border:1px solid #ddd; border-radius:6px; background:#fff; }
.subobjective { margin-left:1.5rem; border-left:2px solid #eee; padding-left:0.5rem; display:flex; align-items:center; }
.objective-title { font-weight:bold; margin-left:0.5rem; }
.progress-container { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; }
.progress-bar { flex:1; height:1rem; border-radius:0.25rem; background:#eee; overflow:hidden; }
.progress-fill { height:100%; background:#facc15; width:0%; transition:width 0.3s ease; }
.toggle-sub { font-size:0.8rem; margin-left:0.5rem; cursor:pointer; background:#f3f4f6; padding:0.2rem 0.5rem; border-radius:4px; }
</style>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="create.html">Create</a>
  <a href="browse.html">Browse</a>
  <a href="my.html">My Challenges</a>
  <a href="feed.html">Feed</a>
  <a href="#" id="auth-link">Login</a>
</nav>

<div class="challenge-card">
  <h1 id="title"></h1>
  <div class="meta" id="game"></div>
  <p id="description"></p>
  <div class="progress-container">
    <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    <span id="progress-text">0%</span>
  </div>
  <div id="objectives"></div>
</div>

<h2>Discussion</h2>
<div id="comments"></div>

<textarea id="comment-input" placeholder="Write a comment..."></textarea>
<button onclick="postComment()">Post</button>

<script>
updateAuthLink();
const params = new URLSearchParams(window.location.search);
const challengeId = params.get("id");
const editKey = params.get("edit");
let challengeData = null;

async function loadChallenge() {
  if(!challengeId) return;
  const {data,error} = await supabaseClient.from("challenges").select("*").eq("id",challengeId).single();
  if(error || !data){ document.body.innerHTML="<p>Challenge not found.</p>"; return; }
  challengeData = data;
  renderChallenge();
}

function renderChallenge() {
  const isEditable = editKey && challengeData.edit_key && editKey===challengeData.edit_key;

  document.getElementById("title").textContent = challengeData.title;
  document.getElementById("game").textContent = "Game: "+challengeData.game;
  document.getElementById("description").textContent = challengeData.description;
const favBtn = document.createElement("button");
favBtn.textContent = "⭐ Save to My Challenges";

favBtn.onclick = async () => {
  const user = await getCurrentUser();
  if (!user) { alert("Log in first"); return; }

  const { error } = await supabaseClient.from("favorites").insert({
    user_id: user.id,
    challenge_id: challengeData.id
  });

  if (!error) {
    favBtn.textContent = "✅ Saved";
    favBtn.disabled = true;
  }
};

document.querySelector(".challenge-card").appendChild(favBtn);

  const objectivesDiv = document.getElementById("objectives");
  objectivesDiv.innerHTML = "";

  const objectives = challengeData.objectives || [];

  objectives.forEach((obj, idx) => {
    const objDiv = document.createElement("div");
    objDiv.className = "objective";

    const objCheckbox = document.createElement("input");
    objCheckbox.type = "checkbox";
    objCheckbox.checked = obj.done || false;
    objCheckbox.disabled = !isEditable;

    objCheckbox.addEventListener("change", async ()=>{
      obj.done = objCheckbox.checked;
      renderProgress();
      if(isEditable) await saveProgress();
    });

    const objTitle = document.createElement("span");
    objTitle.className="objective-title";
    objTitle.textContent = obj.title + ": " + obj.description;

    objDiv.appendChild(objCheckbox);
    objDiv.appendChild(objTitle);

    // Sub-objectives container
    if(obj.subObjectives && obj.subObjectives.length){
      const toggle = document.createElement("button");
      toggle.className="toggle-sub";
      toggle.textContent="Toggle Sub-Objectives";
      let subVisible = true;
      toggle.addEventListener("click", ()=>{ 
        subVisible = !subVisible; 
        subContainer.style.display = subVisible?"block":"none"; 
      });
      objDiv.appendChild(toggle);

      const subContainer = document.createElement("div");
      obj.subObjectives.forEach((sub,sidx)=>{
        const subDiv = document.createElement("div");
        subDiv.className="subobjective";

        const subCheckbox = document.createElement("input");
        subCheckbox.type="checkbox";
        subCheckbox.checked = sub.done || false;
        subCheckbox.disabled = !isEditable;

        subCheckbox.addEventListener("change", async ()=>{
          sub.done = subCheckbox.checked;
          renderProgress();
          if(isEditable) await saveProgress();
        });

        const subTitle = document.createElement("span");
        subTitle.textContent = sub.title + ": " + sub.description;

        subDiv.appendChild(subCheckbox);
        subDiv.appendChild(subTitle);
        subContainer.appendChild(subDiv);
      });
      objDiv.appendChild(subContainer);
    }

    objectivesDiv.appendChild(objDiv);
  });

  renderProgress();
}

function renderProgress() {
  let total=0, done=0;
  const objectives = challengeData.objectives || [];
  objectives.forEach(obj=>{
    total++; if(obj.done) done++;
    (obj.subObjectives||[]).forEach(sub=>{ total++; if(sub.done) done++; });
  });
  const percent = total?Math.round(done/total*100):0;
  document.getElementById("progress-fill").style.width = percent+"%";
  document.getElementById("progress-text").textContent = percent+"%";
}

async function saveProgress(){
  const {error} = await supabaseClient.from("challenges").update({objectives:challengeData.objectives}).eq("id",challengeData.id);
  if(error) console.error("Error saving progress:",error.message);
}

loadChallenge();

async function loadComments(challengeId) {
  const { data, error } = await supabaseClient
    .from("comments")
    .select("content, created_at, user_id")
    .eq("challenge_id", challengeId)
    .order("created_at", { ascending: true });

  if (error) return console.error(error);

  const list = document.getElementById("comments");
  list.innerHTML = "";

  data.forEach(c => {
    const div = document.createElement("div");
    div.className = "comment";
    div.innerHTML = `
      <strong>User</strong>
      <p>${c.content}</p>
      <span class="meta">${new Date(c.created_at).toLocaleString()}</span>
    `;
    list.appendChild(div);
  });
}

async function postComment() {
  const user = await getCurrentUser();
  if (!user) return alert("Login first.");

  const content = document.getElementById("comment-input").value.trim();
  if (!content) return;

  await supabaseClient.from("comments").insert({
    user_id: user.id,
    challenge_id: challengeId,
    content
  });

  document.getElementById("comment-input").value = "";
  loadComments(challengeId);
}

loadComments();
</script>

</body>
</html>
