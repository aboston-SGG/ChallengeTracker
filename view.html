<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="main.js"></script>
</head>
<body>

<nav>
  <a href="index.html">Home</a>
  <a href="create.html">Create</a>
  <a href="browse.html">Browse</a>
  <a href="my.html">My Challenges</a>
  <a href="feed.html">Feed</a>
  <a href="#" id="auth-link">Login</a>
</nav>

<div class="challenge-card" id="challenge-container">
  <h1 id="title"></h1>
  <p class="meta" id="game"></p>
  <p id="description"></p>
  <p id="progress"></p>

  <h2>Objectives</h2>
  <ul id="objectives"></ul>

  <div class="like-section">
    <button id="likeBtn">❤️ Like</button>
    <span id="likeCount"></span>
  </div>
</div>

<script>
updateAuthLink();

const params = new URLSearchParams(window.location.search);
const challengeId = params.get("id");
const editKey = params.get("edit"); // optional edit key for personal copy

let challengeData;
let isEditable = false;

async function loadChallenge() {
  if (!challengeId) {
    document.body.innerHTML = "<p>No challenge ID provided.</p>";
    return;
  }

  // Load challenge
  const { data, error } = await supabaseClient
    .from("challenges")
    .select("*")
    .eq("id", challengeId)
    .single();

  if (error || !data) {
    document.body.innerHTML = "<p>Challenge not found.</p>";
    console.error(error);
    return;
  }

  challengeData = data;

  // Determine if editable
  isEditable = editKey && data.edit_key && editKey === data.edit_key;

  renderChallenge();
}

function renderChallenge() {
  document.getElementById("title").textContent = challengeData.title;
  document.getElementById("game").textContent = "Game: " + challengeData.game;
  document.getElementById("description").textContent = challengeData.description;

  const list = document.getElementById("objectives");
  list.innerHTML = "";

  challengeData.objectives.forEach((obj, index) => {
    const li = document.createElement("li");

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = obj.done;
    checkbox.disabled = !isEditable;
    checkbox.style.marginRight = "0.5rem";

    checkbox.addEventListener("change", async () => {
      if (!isEditable) return;
      challengeData.objectives[index].done = checkbox.checked;
      updateProgress();
      await saveProgress();
    });

    li.appendChild(checkbox);
    li.appendChild(document.createTextNode(obj.text));
    list.appendChild(li);
  });

  updateProgress();

  // Like button
  const likeBtn = document.getElementById("likeBtn");
  likeBtn.onclick = () => toggleLike(challengeId, "likeBtn", "likeCount");
  updateLikeCount(challengeId, "likeCount");
}

function updateProgress() {
  const completed = challengeData.objectives.filter(o => o.done).length;
  const total = challengeData.objectives.length;
  document.getElementById("progress").textContent =
    `Progress: ${completed} / ${total} (${Math.round((completed / total) * 100)}%)`;
}

async function saveProgress() {
  if (!isEditable) return;

  const { error } = await supabaseClient
    .from("challenges")
    .update({ objectives: challengeData.objectives })
    .eq("id", challengeId);

  if (error) console.error("Error saving progress:", error.message);
}

loadChallenge();
</script>

</body>
</html>
